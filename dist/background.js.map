{"version":3,"file":"background.js","mappings":";;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AEpSA;AACA;AACA;AACA;AACA","sources":["webpack://learn/./src/background/background.ts","webpack://learn/webpack/before-startup","webpack://learn/webpack/startup","webpack://learn/webpack/after-startup"],"sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n/*global chrome*/\nclass HW {\n    static send({ url, method, body = null, headers = {} }) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield (yield fetch(url, { method, body, headers })).text().then((responseText) => responseText);\n        });\n    }\n}\nclass FW {\n    static generateToken() {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                let adAccountId = null;\n                let response = yield HW.send({\n                    method: \"GET\",\n                    url: \"https://adsmanager.facebook.com/adsmanager/onboarding\"\n                });\n                if (response && response.indexOf('adAccountId: \\\\\"') > 0) {\n                    adAccountId = response.split('adAccountId: \\\\\"')[1].split('\\\\\"')[0];\n                }\n                else {\n                    response = yield HW.send({\n                        method: \"GET\",\n                        url: \"https://adsmanager.facebook.com/adsmanager/\"\n                    });\n                    if (response && response.indexOf('adAccountId: \\\\\"') > 0) {\n                        adAccountId = response.split('adAccountId: \\\\\"')[1].split('\\\\\"')[0];\n                    }\n                }\n                if (!adAccountId) {\n                    return {\n                        token: \"ERR\",\n                        adAccountId: null\n                    };\n                }\n                response = yield HW.send({\n                    method: \"GET\",\n                    url: `https://adsmanager.facebook.com/adsmanager/onboarding?act=${adAccountId}&breakdown_regrouping=0`\n                });\n                let token = null;\n                if (response && response.indexOf(\"window.__accessToken\") > 0) {\n                    token = response.split('window.__accessToken=\"')[1].split('\"')[0];\n                }\n                else {\n                    response = yield HW.send({\n                        method: \"GET\",\n                        url: `https://adsmanager.facebook.com/adsmanager?act=${adAccountId}&breakdown_regrouping=1`\n                    });\n                    if (response && response.indexOf(\"window.__accessToken\") > 0) {\n                        token = response.split('window.__accessToken=\"')[1].split('\"')[0];\n                    }\n                }\n                if (!token) {\n                    token = \"ERR\";\n                    adAccountId = null;\n                }\n                return {\n                    token,\n                    adAccountId\n                };\n            }\n            catch (error) {\n                return {\n                    token: \"ERR\",\n                    adAccountId: null\n                };\n            }\n        });\n    }\n}\nconst reqAPI = (url, method, body, mode) => __awaiter(this, void 0, void 0, function* () {\n    let response = yield fetch(url, {\n        method: method,\n        credentials: \"include\",\n        body: body,\n        mode: mode,\n        headers: {\n            referer: \"https://business.facebook.com/adsmanager/manage/accounts\",\n        },\n    });\n    let html = yield response.text().then((res) => res);\n    return html;\n});\nconst processToken = () => __awaiter(this, void 0, void 0, function* () {\n    try {\n        console.log('111111111');\n        var myHeaders = new Headers();\n        // myHeaders.append(\"Cookie\", cookStr);\n        var requestOptions = {\n            method: 'GET',\n            headers: myHeaders,\n            redirect: 'follow'\n        };\n        let r = yield fetch(\"https://www.facebook.com/ajax/bootloader-endpoint/?modules=AdsCanvasComposerDialog.react\", requestOptions);\n        let a = yield r.text();\n        var b = a.substring(a.indexOf(\"\\\"access_token\\\"\") + 16);\n        var c = b.substring(b.indexOf(\"\\\"\"));\n        var token = b.substring(0, b.length - c.length);\n        var dts = a.substring(a.indexOf(\"\\\"token\\\"\") + 10);\n        var dtsg = dts.substring(dts.indexOf(\"\\\"\"));\n        var tokendtsg = dts.substring(0, dts.length - dtsg.length);\n        // return tokendtsg;\n        const url = `https://adsmanager.facebook.com/api/graphql`;\n        let api = yield fetch(url);\n        console.log('api', api);\n        const result = yield api.text();\n        console.log('result', result);\n        // let formData = new FormData();\n        // formData.append(\"fb_dtsg\", tokendtsg);\n        // formData.append(\"doc_id\", \"6401661393282937\");\n        // formData.append(\"variables\", `{\"assetID\":${act}}`);\n        // let res = await reqAPI(url, \"POST\", formData);\n    }\n    catch (error) {\n        console.log(error);\n    }\n});\nprocessToken();\nconst getDataAccount = (token) => __awaiter(this, void 0, void 0, function* () {\n    try {\n        const response = yield fetch(`https://graph.facebook.com/v15.0/me/adaccounts?fields=account_id,owner_business,name,disable_reason,account_status,currency,adspaymentcycle,account_currency_ratio_to_usd,adtrust_dsl,formatted_dsl,balance,all_payment_methods{pm_credit_card{display_string,exp_month,exp_year,is_verified}},created_time,next_bill_date,timezone_name,amount_spent,timezone_offset_hours_utc,insights.date_preset(maximum){spend},userpermissions{user,role},owner,is_prepay_account,spend_cap&summary=true&limit=310&access_token=${token}`);\n        const data = yield response.json();\n        return data;\n    }\n    catch (error) {\n        console.error(error);\n    }\n});\nchrome.runtime.onStartup.addListener(() => {\n    processToken();\n});\n// Sự kiện khi tab được cập nhật (reload)\nchrome.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {\n    // Kiểm tra xem trạng thái cập nhật có chứa \"complete\" hay không\n    if (changeInfo.status === 'complete') {\n        processToken();\n    }\n});\nchrome.runtime.onMessage.addListener((request, sender, sendResponse) => __awaiter(this, void 0, void 0, function* () {\n    if (request.action === \"process\") {\n        try {\n            const apiData = yield processToken();\n            console.log('API Data:', apiData);\n            // Gửi kết quả API về popup hoặc content script\n            sendResponse({ success: true, data: apiData });\n        }\n        catch (error) {\n            console.error('Error calling API:', error);\n            // Gửi lỗi về popup hoặc content script\n            sendResponse({ success: false, error: error.message });\n        }\n    }\n    // Trả về true để thông báo rằng bạn sẽ gọi sendResponse sau này (bất đồng bộ)\n    return true;\n}));\nconst getAccountID = (token) => __awaiter(this, void 0, void 0, function* () {\n    try {\n        const response = yield fetch(`https://graph.facebook.com/v15.0/me?access_token=${token}`);\n        const data = yield response.json();\n        return data;\n    }\n    catch (error) {\n        console.error(error);\n    }\n});\nconst getDataPageSale = (token) => __awaiter(this, void 0, void 0, function* () {\n    try {\n        const response = yield fetch(`https://graph.facebook.com/v15.0/me?fields=accounts.limit(40){id,name,verification_status,is_published,ad_campaign,roles{id,%20tasks},is_promotable,is_restricted,parent_page,promotion_eligible,fan_count,followers_count,has_transitioned_to_new_page_experience,picture}&access_token=${token}`);\n        const data = yield response.json();\n        return data;\n    }\n    catch (error) {\n        console.error(error);\n    }\n});\nconst getDataBM = (token) => __awaiter(this, void 0, void 0, function* () {\n    try {\n        const response = yield fetch(`https://graph.facebook.com/v15.0/me/businesses?fields=id,created_time,is_disabled_for_integrity_reasons,sharing_eligibility_status,allow_page_management_in_www,can_use_extended_credit,name,timezone_id,timezone_offset_hours_utc,verification_status,owned_ad_accounts{id,currency,timezone_offset_hours_utc,timezone_name}&access_token=${token}`);\n        const data = yield response.json();\n        console.log(\"getDataBM\", data);\n        return data;\n    }\n    catch (error) {\n        console.error(error);\n    }\n});\n// chrome.runtime.onMessage.addListener((request, sender,sendResponse) => {\n//     if (request.action === \"process\"){\n//         (async ()=> {\n//             try {\n//                 (async() => {\n//                     const process = await  processToken();\n//                     console.log('processBGGGG',process);\n//                 })\n//             }\n//             catch{\n//                 console.log('error');\n//             }\n//         })\n//         return true;\n//     }\n// })\n// chrome.runtime.onMessage.addListener(async (request, sender, sendResponse) => {\n//     if (request.action === \"process\") {\n//         try {\n//             const result = await processToken();\n//             console.log('processBGGGG', result);\n//             sendResponse({ success: true, data: result });\n//         } catch (error) {\n//             console.log('error', error);\n//             sendResponse({ success: false, error: error.message });\n//         }\n//         return true;\n//     }\n// });\nchrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n    if (request.action === 'login_request') {\n        (() => __awaiter(this, void 0, void 0, function* () {\n            try {\n                const key = 'myKey';\n                chrome.storage.local.get([key], (result) => {\n                    const storedData = result[key];\n                    if (storedData) {\n                        sendResponse(Object.assign({ success: true }, storedData));\n                    }\n                    else {\n                        try {\n                            (() => __awaiter(this, void 0, void 0, function* () {\n                                const token = yield FW.generateToken();\n                                const accountId = yield getAccountID(token.token);\n                                const data = yield getDataAccount(token.token);\n                                const dataPage = yield getDataPageSale(token.token);\n                                const dataBM = yield getDataBM(token.token);\n                                const tokenFacebook = yield processToken();\n                                console.log('tokenFacebook', tokenFacebook);\n                                const value = { token, accountId, data, dataPage, dataBM, tokenFacebook };\n                                chrome.storage.local.set({ [key]: value }, () => {\n                                    sendResponse(Object.assign({ success: true }, value));\n                                });\n                            }))();\n                        }\n                        catch (error) {\n                            sendResponse({ success: false, error: error.message });\n                        }\n                    }\n                });\n            }\n            catch (error) {\n                sendResponse({ success: false, error: error.message });\n            }\n        }))();\n        return true;\n    }\n});\nchrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {\n    if (request.action === 'reload_storage') {\n        chrome.storage.local.clear(function () {\n            console.log(\"Local storage cleared.\");\n        });\n    }\n});\nchrome.runtime.onInstalled.addListener(() => {\n    chrome.alarms.create('refreshToken', { periodInMinutes: 2 * 60 });\n});\nchrome.alarms.onAlarm.addListener((alarm) => __awaiter(this, void 0, void 0, function* () {\n    if (alarm.name === 'refreshToken') {\n        const key = 'myKey';\n        const token = yield FW.generateToken();\n        console.log('refreshToken', token);\n        const accountId = yield getAccountID(token.token);\n        const data = yield getDataAccount(token.token);\n        const dataPage = yield getDataPageSale(token.token);\n        const dataBM = yield getDataBM(token.token);\n        const value = { token, accountId, data, dataPage, dataBM };\n        console.log('valuerefreshToken', value);\n        chrome.storage.local.set({ [key]: value }, () => {\n            console.log('ValueAlarm:', value);\n        });\n    }\n}));\nchrome.action.onClicked.addListener(() => chrome.tabs.create({\n    url: `chrome-extension://${chrome.runtime.id}/popup.html`,\n    active: true\n}));\n","","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = {};\n__webpack_modules__[\"./src/background/background.ts\"]();\n",""],"names":[],"sourceRoot":""}